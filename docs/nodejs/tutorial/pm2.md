# Менеджер процессов PM2

Для обеспечения непрерывной работоспособности Node.js сервера нужно либо постоянно держать открытой консоль, либо использовать [менеджер процессов pm2](https://pm2.io/doc/en/runtime/overview/). Он имеет встроенный балансировщик нагрузки, позволяет следить за потребляемыми ресурсами запущенных процессов, автоматически перезапускать процессы после системного сбоя и т. д.

Менеджер процессов `pm2` имеется в репозитории npm и должен быть установлен в системе глобально.

```
npm install pm2 -g
```

## Управление процессами

Запуск Node.js сервера с использованием `pm2` осуществляется командой `start`, которой передается путь к главному файлу приложения.

```
pm2 start app.js
```

Команда `start` инициирует запуск приложения в фоновом режиме и добавляет его в список процессов, который можно увидеть выполнив команду `ls`.

```
pm2 ls
```

Перечень полей таблицы:

- `app name` - имя приложения (по умолчанию имя главного файла без расширения), для задания собственного названия используйте при запуске параметр `--name`: `pm2 start app.js --name=custom_app_name`
- `id` - уникальный идентификатор приложения;
- `mode` - режим, в котором был запущен сервер (`fork` или `cluster`);
- `pid` - уникальный идентификатор процесса в системе;
- `status` - статус приложения, может быть `launching`, `online`, `errored` или `stopped`;
- `restart` - количество перезапусков;
- `uptime` - время, прошедшее с момента запуска приложения;
- `cpu` - нагрузка на процессор в процентах;
- `mem` - занимаемая приложением оперативная память.

!!! note ""

    Для получения более подробной информации о количестве запросов, параметрах запуска процессов и т. д. используйте команду `monit`.

За перезапуск процесса отвечает команда `restart`, принимающая имя или идентификатор приложения.

```
pm2 restart app
```

!!! note ""

    Выполнение `restart` увеличивает значение одноименного поля в списке процессов применительно к тому из них, для которого была выполнена команда.

Остановка процесса осуществляется командой `stop`, которой необходимо указать либо название, либо идентификатор приложения.

```
pm2 stop app
```

Выполнение `stop` останавливает работу приложения, но не удаляет его из списка процессов, статус при этом будет `stopped`.

Чтобы остановить процесс и удалить его из списка, используйте команду `delete`.

```
pm2 delete app
```

Посмотреть консольные логи приложения можно командой `log`. Если для `log` не указать приложение, то будут выведены логи всех процессов, отсортированные по времени.

```
pm2 log app
```

!!! note ""

    Командам `restart`, `stop`, `delete` и `log` можно передать через пробел сразу несколько процессов для обработки.

```
pm2 delete app1 app2 app3
```

Для возможности восстановления и запуска списка процессов в случае перезапуска или непредвиденного сбоя сервера, сохраните текущую конфигурацию на диск выполнив команду `save`.

```
pm2 save
```

После этого сохраненные процессы могут быть запущены следующим образом.

```
pm2 resurrect
```

## Распределение нагрузки (кластеризация)

Запуск приложения в нескольких экземплярах, которые будут распределять между собой поступающие запросы, осуществляется с использованием параметра `-i` (instances) у команды `start`, с помощью которого указывается, сколько экземпляров запустить. Создание дополнительных процессов одного и того же приложения называется [кластеризацией](cluster.md).

```
pm2 start app.js -i 2
```

Приведенная команды запускает приложение в двух экземплярах. Помните, что для эффективной работы кластера количество дополнительных процессов не должно превышать количество ядер процессора. Чтобы запустить количество процессов равное количеству ядер, укажите параметру `-i` значение `max`.

```
pm2 start app.js -i max
```

В данном случае Node.js `pm2` самостоятельно определит количество ядер процессора и создаст соответствующее количество дополнительных экземпляров.

## Файл ecosystem.config.js

Если разработанная вами система состоит из множества приложений, которым к тому же при запуске необходимо указывать массу параметров, то при развертывании на разных серверах этот процесс займет немало времени. Чтобы оптимизировать все это, в `pm2` имеется поддержка запуска приложений из конфигурационного файла - `ecosystem.config.js`.

Чтобы сгенерировать шаблон `ecosystem.config.js` воспользуйтесь следующей командой.

```
pm2 init
```

Теперь в директории, откуда была выполнена команда, должен появиться файл `ecosystem.config.js` с таким содержимым.

_ecosystem.config.js_

```js
module.exports = {
  apps: [
    {
      name: 'app',
      script: './app.js',
      env: {
        NODE_ENV: 'development',
      },
      env_production: {
        NODE_ENV: 'production',
      },
    },
  ],
}
```

В массиве `apps` каждый элемент является объектом, описывающим конфигурацию для запуска одного приложения набором параметров. Рассмотрим основные из них:

- `name` - имя приложения, которое будет отображаться в списке процессов при выполнении команды `pm2 list`;
- `script` - путь к главному файлу приложения, который отвечает за запуск;
- `instances` - запускает процесс в кластерном режиме, в качестве значения передается количество дополнительных экземпляров;
- `disable_logs` - если задать `true`, то логи вестись не будут;
- `env` - значение переменной среды окружения `NODE_ENV` в режиме разработки;
- `env_production` - значение переменной среды окружения `NODE_ENV` в режиме эксплуатации.

!!! note ""

    ПС полным списком параметров можно ознакомиться в официальной документации.

Для запуска описанных в `ecosystem.config.js` приложений, выполните команду `start` с указанием пути к файлу.

```
pm2 start ecosystem.config.js
```

Если вам нужно запустить только одно приложение из описанного массива, укажите параметр `--only` и значение поля `name` из конфигурации.

```
pm2 start ecosystem.config.js --only my-app
```

## Лимит использования RAM

Менеджер процессов Node.js pm2 позволяет настроить перезапуск процесса по достижению использования им указанного объема оперативной памяти. Для этого при запуске приложения необходимо указать параметр `--max-memory-restart`.

```
pm2 start index.js --max-memory-restart 150M
```

Значение параметра указывается в одном из трех возможных измерений:

- `K` (килобайты);
- `M` (мегабайты)
- `G` (гигабайты).

!!! note ""

    Проверка использования процессами оперативной памяти осуществляется pm2 раз в 30 секунд.

## Детектирование изменений

В pm2 также можно настроить автоматический перезапуск приложения при изменении одного из его файлов. Для этого при старте приложения укажите параметр `--watch`.

```
pm2 start index.js --watch
```

Процесс отслеживания изменений не завершается с остановкой процесса приложения. Чтобы отключить его, при выполнении команды `stop` также необходимо передать параметр `--watch`.

```
pm2 stop index --watch
```

Параметр `--watch` имеет ряд параметров, но их указание возможно только через файл `ecosystem.config.js`.

_ecosystem.config.js_

```js
module.exports = {
  apps: [
    {
      name: 'my-app',
      script: './index.js',
      watch: ['server'],
      ignore_watch: ['node_modules', 'client'],
      watch_delay: 1000,
    },
  ],
}
```

Здесь в параметре `watch` явно указывается, изменений каких директорий необходимо отслеживать. Чтобы исключить из отслеживания определенные директории, имеется параметр `ignore_watch`. А с помощью `watch_delay` указывается время в миллисекундах, которое необходимо выждать при перезапуске приложения, прежде чем инициировать процесс детектирования изменений.
